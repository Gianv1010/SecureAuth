server {
  listen 443 ssl;
  server_name localhost;

  ssl_certificate     /etc/nginx/certs/localhost.pem;
  ssl_certificate_key /etc/nginx/certs/localhost-key.pem;

  # -------------------------
  # (Opzionale ma consigliato) Security headers
  # -------------------------
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # -------------------------
  # Backend API
  # -------------------------
  location /api/ {

    # --- CORS headers (sempre) ---
    add_header 'Access-Control-Allow-Origin' "$http_origin" always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
    add_header 'Vary' 'Origin, Access-Control-Request-Method, Access-Control-Request-Headers' always;

    # --- Preflight (OPTIONS) ---
    if ($request_method = OPTIONS) {
      add_header 'Access-Control-Max-Age' 86400 always;
      add_header 'Content-Length' 0;
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      return 204;
    }

    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # -------------------------
  # Frontend (SPA)
  # -------------------------
  location / {
    proxy_pass http://frontend:80;
    proxy_set_header Host $host;

    # SPA fallback (React Router)
    proxy_intercept_errors on;
    error_page 404 = /index.html;
  }
}
